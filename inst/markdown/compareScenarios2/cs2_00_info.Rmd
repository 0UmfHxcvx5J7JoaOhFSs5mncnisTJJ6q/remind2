## File Reference Table

```{r}
scenarioColors <- plotstyle(fileReference$newScenarioName)
lightenColor <- function(clr, by) {
  colRGB <- colorRamp(c(clr, "white"))(by)
  rgb(colRGB[1], colRGB[2], colRGB[3], maxColorValue=255)
}
bkgndColors <- sapply(scenarioColors, lightenColor, by=0.5)
```

```{r}
fileReference %>%
  select(fileid, newScenarioName, scenario, path) %>%
  # WORKAROUND:
  # Windows file paths may contain backslashes.
  # But knitr::kable(x, "html"), which will be called by kbl() below,
  # does not handle backslashes well. => Replace them with forward slashes.
  mutate(path = str_replace_all(path, fixed("\\"), "/")) %>%
  kbl(
    booktabs = TRUE,
    col.names = c("ID", "Name Used Here", "Original Name", "Path")) %>%
  kable_styling(
    bootstrap_options = c("condensed"),
    latex_options = c("hold_position")) %>%
  column_spec(2:3, width = "5cm") %>%
  column_spec(4, width = "15cm") %>% 
  column_spec(1:4, background = bkgndColors)
```


```{r results='asis'}
if (exists("cfgTopLevel") && !is.null(cfgTopLevel)) {
  
  cat("## Descriptions\n\n")
  
  for (i in 1:max(fileReference$fileid)) {
    cat("### ", as.character(fileReference$newScenarioName[i]), "\n\n")
    
    cfgTopLevel %>% 
      filter(fileid == i, name == "description") %>% 
      pull(value) %>% 
      pluck(1) ->
      description
    cat(description, "\n\n")
  }
}
```


```{r results='asis'}
# If paths to config files are provided in the parameter configFiles, their
# content is written to the objects cfgGms and cfgTopLevel in cs2main.Rmd. Here
# relevant parts of these configs are displayed.
if (exists("cfgGms") && !is.null(cfgGms)) {
  varsPerTable <- 5 # Number of variable columns in table.
  firstColumnWidth <- 50 # in mm; first column shows the scenario title.
  pageTextWidth <- 297-2*5 # in mm; DIN A4 landscape minus margins.
  cellMargin <- 5 # in mm
  
  cat ("## GAMS Config Differences\n\n")
  
  cfgGms %>% 
    left_join(fileReference %>% select(fileid, newScenarioName), by = "fileid") %>%
    select(-path, -fileid) %>% 
    rename(scenario = newScenarioName) %>% 
    pivot_wider(names_from = name, values_from = value) %>% 
    mutate(across(-scenario, unlist)) %>% 
    select(-where(~length(unique(.)) == 1)) %>% 
    select(scenario, everything()) ->
    gmsCfgDifferences
  k <- ncol(gmsCfgDifferences) - 1
  nTables <- ceiling(k / varsPerTable)
  for (i in seq_len(nTables)) {
    if (i == nTables && k %% varsPerTable != 0) {
      cols <- k %% varsPerTable
    } else {
      cols <- varsPerTable
    }
    colIdx <- 1 + 1:cols + (i-1)*varsPerTable
    tbl <- gmsCfgDifferences[, c(1, colIdx)]
    tbl %>% 
      kbl(booktabs = TRUE, align="c") %>%
      column_spec(
        1:(cols+1), 
        background = bkgndColors
      ) %>%  
      kable_styling(
        bootstrap_options = c("condensed"),
        latex_options = c("hold_position")
      ) %>%
      column_spec(
        1, 
        width = paste0(firstColumnWidth, "mm"),
        bold = TRUE,
      ) %>%
      column_spec(
        1 + 1:cols, 
        width = paste0((pageTextWidth-firstColumnWidth)/varsPerTable-cellMargin, "mm"),
      ) %>% 
      row_spec(
        0,
        monospace = TRUE,
        bold = TRUE
      ) %>% 
      cat("\n\n")
  }
}
```

\newpage
