---
title: "Compare Scenarios 2"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
  pdf_document:
    toc: yes
    number_sections: yes
params:
  mif: !r c("C:/Users/cschoetz/Documents/compareScenarios/mif/REMIND/REMIND_generic_SSP2EU-AMT-NDC.mif", "C:/Users/cschoetz/Documents/compareScenarios/mif/REMIND/REMIND_generic_SSP2EU-AMT-PkBudg1520.mif")
  hist: "C:/Users/cschoetz/Documents/compareScenarios/mif/REMIND/historical.mif"
  y: !r c(seq(2005, 2060, 5), seq(2070, 2100, 10))
  y_hist: !r c(seq(1960, 2020, 1), seq(2025, 2100, 5))
  y_bar: !r c(2010, 2030, 2050, 2100)
  reg: !r NULL
  mainReg: "World"
---


```{r includes, include=FALSE}
INCLUDE_SUMMARY <- FALSE
INCLUDE_MACRO <- FALSE
INCLUDE_EMISSIONS <- FALSE
INCLUDE_ENERGY_SUPPLY <- FALSE
INCLUDE_ENERGY_DEMAND <- TRUE#FALSE
INCLUDE_ENERGY_SERVICES <- FALSE
INCLUDE_CLIMATE <- FALSE
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  fig.width = 14, 
  fig.height = 8)
```


```{r libraries, include=FALSE}
library(gridExtra)
library(tidyverse)
library(quitte)
library(mip)
```


```{r read mifs}
# Read *.mif-files.
read.quitte(params$mif, factors=FALSE) %>% 
  # In the variable names, remove all occurrences of one or more consecutive "+" followed by "|".
  mutate(variable = str_remove(variable, "\\+{1,}\\|")) -> 
  dataScenarios
read.quitte(params$hist, factors=FALSE) %>% 
  mutate(variable = str_remove(variable, "\\+{1,}\\|")) ->
  dataHistorical

# Filter years.
dataScenarios %>% 
  filter(period %in% params$y) ->
  dataScenarios
dataHistorical %>% 
  filter(period %in% params$y_hist) ->
  dataHistorical

# Use only following models from historical data.
hist_filter <- tribble(
  ~variable, ~model,
  "Population", "WDI",
  "GDP|PPP", "James_IMF",
  "FE", "IEA",
  "FE|Transport", "IEA",
  "FE|Buildings", "IEA",
  "FE|Industry", "IEA")
dataHistorical %>% 
  filter(!is.na(value), !variable %in% hist_filter$variable) %>% 
  bind_rows(dataHistorical %>% semi_join(hist_filter)) ->
  dataHistorical

# Combine into one data frame.
data <- bind_rows(dataScenarios, dataHistorical)

# Filter regions.
if (!is.null(params$reg)) {
  data %>% 
    filter(region %in% params$reg) ->
    data
}
```


```{r calcuate pCap variables}
# TODO: breaks down if input units change
pCapVariables <- tribble(
  ~variable, ~newUnit, ~conversionFactor,
  "FE", "GJ/yr", 1e9,
  "FE|CDR", "GJ/yr", 1e9,
  "FE|Transport", "GJ/yr", 1e9,
  "FE|Buildings", "GJ/yr", 1e9,
  "FE|Industry", "GJ/yr", 1e9,
  "GDP|PPP", "kUS$2005", 1e6)

data %>% 
  filter(variable == "Population") %>% 
  select(scenario, region, period, value) %>% 
  mutate(population = value * 1e6) %>% # unit originally is million, now is 1
  select(!value) -> 
  dataPop

data %>% 
  inner_join(pCapVariables) %>% 
  left_join(dataPop) %>% 
  mutate(
    value = value / population * conversionFactor,
    variable = paste0(variable, " pCap"),
    unit = newUnit,
    newUnit = NULL,
    conversionFactor = NULL,
    population = NULL) ->
  dataPCap

data %>% 
  bind_rows(dataPCap) ->
  data
```


```{r add gdp column}
# GDP|PPP pCap (kUS$2005)
# TODO: looses unit info and pCap (place as variable name?)
data %>% 
  filter(variable == "GDP|PPP pCap") %>% 
  select(scenario, region, period, value) %>% 
  rename(gdp = value) ->   
  dataGDP
data %>% 
  left_join(dataGDP) ->
  data
```


```{r calcuate pGDP variables}
pGdpVariables <- tribble(
  ~variable, ~newUnit, ~conversionFactor,
  "FE", "MJ/US$2005", 1e3,
  "FE|CDR", "MJ/US$2005", 1e3,
  "FE|Transport", "MJ/US$2005", 1e3,
  "FE|Buildings", "MJ/US$2005", 1e3,
  "FE|Industry", "MJ/US$2005", 1e3)
data %>% 
  inner_join(pGdpVariables) %>% 
  mutate(
    value = value / gdp * conversionFactor,
    variable = paste0(variable, " pGDP"),
    unit = newUnit,
    newUnit = NULL, conversionFactor = NULL) ->
  dataPGdp
data %>% 
  bind_rows(dataPGdp) ->
  data
```


```{r corrections}
# TODO: This should definitely not be done here!!

# correct SE|Electricity|Hydrogen, current value is FE, SE can be calculated by estimating turbine efficiency
data %>% 
  mutate(value = value / ifelse(variable == "SE|Electricity|Hydrogen", 0.4, 1)) ->
  data
```


```{r set params}
# Define parameters for use in plotting. 
# TODO: not particularly nice style...
variables <- unique(data$variable)
regions <- unique(data$region)
mainReg <- params$mainReg
y_bar <- params$y_bar
```


```{r clean environment}
# TODO: remove variables that are not used anymore
```


```{r eval=FALSE}
# TODO: remove, make compareScanarios2HelpVignette
# NOTE: regex to remove units: "([^(]+) \([^)]+\)+" replace by "\1"
# NOTE: filtering and ordering scheme
data %>% 
  filter(variable %in% items) %>% 
  #mutate(variable = fct_relevel(variable, items)) %>% # order as in items
  #mutate(variable = fct_reorder2(variable, period, value, first2, .desc=FALSE)) %>% # order by value in first year
  #mutate(variable = fct_reorder(variable, value, sum)) %>% # order by area
  mutate(variable = fct_reorder(variable, value, sum)) ->
  d
```


```{r def showAreaAndBarPlots}
showAreaAndBarPlots <- function(
  data, items, tot = NULL, 
  mainReg = "World",
  y_bar = c(2010, 2030, 2050, 2100)) {
  
  data %>% 
    filter(variable %in% items, scenario != "historical") %>% 
    mutate(variable = fct_reorder(variable, value, mean, na.rm=TRUE)) ->
    d
  
  # Create plots.
  d %>% 
    filter(region == mainReg) %>% 
    mipArea(scales="free_y", total = is.null(tot)) + 
    theme(legend.position="none") ->
    p1
  if (!is.null(tot)) {
    p1 <- p1 +
      geom_line(
        d = d %>% filter(region == mainReg, variable == tot), 
        mapping = aes(period, value),
        size=1.3)
  }
  
  d %>% 
    filter(region == mainReg, period %in% y_bar) %>% 
    mipBarYearData() +
    theme(legend.position="none") ->
    p2
  
  d %>% 
    filter(region != mainReg, period %in% y_bar) %>% 
    mipBarYearData() +
    guides(fill=guide_legend(ncol=3)) ->
    p3
  
  d %>% 
    filter(region != mainReg) %>% 
    mipArea(scales="free_y", total = is.null(tot)) ->
    p4
  
  grid.arrange(p1, p2, p3, layout_matrix = rbind(c(1, 3), c(2, 3)))
  plot(p4)
  
  return(invisible(NULL))
}
```


```{r def showLinePlots}
showLinePlots <- function(data, filter_variable=NULL, mainReg = "World") {
  if (!is.null(filter_variable)) {
    d <- filter(data, variable %in% filter_variable)
  } else {
    d <- data
  }
  # If there is no scenario data, do nothing.
  if (NROW(filter(d, scenario != "historical")) == 0) return(invisible(NULL))
  
  label <- paste0(filter_variable, " (", paste0(unique(d$unit), collapse="|"), ")")
  d %>% 
    filter(region == mainReg, scenario != "historical") %>% 
    mipLineHistorical(
      x_hist = d %>% filter(region == mainReg, scenario == "historical"),
      ylab = label,
      scales = "free_y",
      plot.priority = c("x_hist","x","x_proj")) ->
    p1
  d %>% 
    filter(region != mainReg, scenario != "historical") %>% 
    mipLineHistorical(
      x_hist = d %>% filter(region != mainReg, scenario == "historical"),
      ylab = NULL,
      scales = "free_y",
      plot.priority = c("x_hist","x","x_proj"),
      facet.ncol = 3) ->
    p2
  
  grid.arrange(p1, p2, nrow=1)
  
  return(invisible(NULL))
}
```

```{r def showLinePlotsWithTarget}
showLinePlotsWithTarget <- function(data, filter_variable) {
  filter_variable %>% 
    paste0("|target|") %>% 
    str_replace_all(fixed("|"), fixed("\\|")) %>% 
    paste0(collapse="|") ->
    target_pattern
  
  data %>% 
    filter(str_detect(variable, target_pattern)) ->
    dTar
  regionsWithTarget <- unique(dTar$region)
  data %>% 
    filter(variable %in% filter_variable, region %in% regionsWithTarget) ->
    d
  if (NROW(d) == 0) return(invisible(NULL))
  
  label <- paste0(filter_variable, " (", paste0(unique(d$unit), collapse="|"), ")")
  d %>% 
    filter(scenario != "historical") %>% 
    mipLineHistorical(
      x_hist = d %>% filter(scenario == "historical"),
      ylab = label,
      scales = "free_y",
      plot.priority = c("x_hist","x","x_proj"),
      facet.ncol = 3) + 
    geom_hline(data = dTar, aes(yintercept=value), linetype=2, color = "coral") +
    geom_vline(data = dTar, aes(xintercept=period), linetype=2, color = "coral") +
    geom_text(data = dTar, aes(x=max(d$period) - (max(d$period) - min(d$period)) / 4, y=value, label = paste(variable, period))) ->
    p
  print(p)
  
  return(invisible(NULL))
}
```

```{r keepFinalVariables}
keepFinalVariables <- function(vars) { # TODO
  vars <- sort(vars)
  varsNext <- c(vars[-1], vars[1])
  isPrefix <- str_starts(varsNext, fixed(vars))
  vars[!isPrefix]
}
```




```{r CLICK "RUN ALL RUNS ABOVE" HERE TO PREPARE YOUR ENVIRONMENT}
```


```{r summary, child = if (INCLUDE_SUMMARY) 'cs2_summary.Rmd'}
```

```{r macro, child = if (INCLUDE_MACRO) 'cs2_macro.Rmd'}
```

```{r macro, child = if (INCLUDE_EMISSIONS) 'cs2_emissions.Rmd'}
```

```{r macro, child = if (INCLUDE_ENERGY_SUPPLY) 'cs2_energy_supply.Rmd'}
```

```{r macro, child = if (INCLUDE_ENERGY_DEMAND) 'cs2_energy_demand.Rmd'}
```

```{r macro, child = if (INCLUDE_ENERGY_SERVICES) 'cs2_energy_services.Rmd'}
```

```{r macro, child = if (INCLUDE_CLIMATE) 'cs2_climate.Rmd'}
```

