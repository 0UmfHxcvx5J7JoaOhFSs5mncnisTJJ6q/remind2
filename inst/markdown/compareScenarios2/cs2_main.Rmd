---
title: "Compare Scenarios 2"
date: '`r format(Sys.Date())`'
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
  pdf_document:
    toc: yes
    number_sections: yes
params:
  mif: 
  - "C:/Users/chris/Documents/PIK/mif/REMIND/REMIND_generic_SSP2EU-AMT-NDC.mif"
  - "C:/Users/chris/Documents/PIK/mif/REMIND/REMIND_generic_SSP2EU-AMT-PkBudg1520.mif"
  hist: "C:/Users/chris/Documents/PIK/mif/REMIND/historical.mif"
  y: !r c(seq(2005, 2060, 5), seq(2070, 2100, 10))
  y_hist: !r c(seq(1960, 2020, 1), seq(2025, 2100, 5))
  y_bar: !r c(2010, 2030, 2050, 2100)
  reg: null
  includes: null
  mainReg: "World"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  fig.width = 14, 
  fig.height = 8)
```


```{r libraries, include=FALSE}
library(gridExtra)
options(tidyverse.quiet = TRUE)
library(tidyverse)
library(quitte)
library(mip)
```


```{r read mifs}
# Read *.mif-files.
read.quitte(params$mif, factors=FALSE) ->
  dataScenarios
read.quitte(params$hist, factors=FALSE) ->
  dataHistorical

# Filter years.
dataScenarios %>% 
  filter(period %in% params$y) ->
  dataScenarios
dataHistorical %>% 
  filter(period %in% params$y_hist, !is.na(value)) ->
  dataHistorical

# Combine into one data frame.
data <- bind_rows(dataScenarios, dataHistorical)

# In the variable names, replace |+|, |++|, |+++|, ... by |.
data %>% 
  mutate(variable = str_replace_all(variable, "\\|\\++\\|", "|")) ->
  data
  
# For following variables, use only following models for the given scenario.
model_filter <- tribble(
  ~scenario, ~variable, ~model, 
  "historical", "Population", "WDI",
  "historical", "GDP|PPP", "James_IMF",
  "historical", "FE", "IEA",
  "historical", "FE|Transport", "IEA",
  "historical", "FE|Buildings", "IEA",
  "historical", "FE|Industry", "IEA")
data %>% 
  # Remove all matching variable, scenario combinations.
  anti_join(model_filter, by=c("variable", "scenario")) %>% 
  # Add only matching variable, scenario, model combinations.
  bind_rows(data %>% semi_join(model_filter)) ->
  data

# Filter regions.
if (!is.null(params$reg)) {
  data %>% 
    filter(region %in% params$reg) ->
    data
}
```


```{r calcuate pCap variables}
# For all variables in following table, add a new variable to data with the name
# "OldName pCap". Calculate its value by
#     OldValue * conversionFactor 
# and set its unit to newUnit. 
# The new variable "OldName pCap" will be available in the plot sections.
pCapVariables <- tribble(
  ~variable, ~newUnit, ~conversionFactor,
  "FE", "GJ/yr", 1e9,
  "FE|CDR", "GJ/yr", 1e9,
  "FE|Transport", "GJ/yr", 1e9,
  "FE|Buildings", "GJ/yr", 1e9,
  "FE|Industry", "GJ/yr", 1e9,
  "GDP|PPP", "kUS$2005", 1e6,
  "ES|Transport|Pass", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV", "km/yr", 1e9,
  "ES|Transport|Pass|non-LDV", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV|BEV", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV|FCEV", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV|Gases", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV|Hybrid Electric", "km/yr", 1e9,
  "ES|Transport|Pass|Road|LDV|Liquids", "km/yr", 1e9,
  "ES|Transport|Freight", "tkm/yr", 1e9,
  "ES|Transport|Freight|Road|Electric", "tkm/yr", 1e9,
  "ES|Transport|Freight|Road|FCEV", "tkm/yr", 1e9,
  "ES|Transport|Freight|Road|Gases", "tkm/yr", 1e9,
  "ES|Transport|Freight|Road|Liquids", "tkm/yr", 1e9)

data %>% 
  filter(variable == "Population") %>% 
  select(scenario, region, period, value) %>% 
  mutate(population = value * 1e6) %>% # unit originally is million, now is 1
  select(!value) -> 
  dataPop

data %>% 
  inner_join(pCapVariables) %>% 
  left_join(dataPop) %>% 
  mutate(
    value = value / population * conversionFactor,
    variable = paste0(variable, " pCap"),
    unit = newUnit,
    newUnit = NULL,
    conversionFactor = NULL,
    population = NULL) ->
  dataPCap

data %>% 
  bind_rows(dataPCap) ->
  data
```


```{r add gdp column}
# Create a new column gdp with the value of GDP|PPP pCap (kUS$2005).
data %>% 
  filter(variable == "GDP|PPP pCap") %>% 
  select(scenario, region, period, value) %>% 
  rename(gdp = value) ->   
  dataGDP
data %>% 
  left_join(dataGDP) ->
  data
```


```{r calcuate pGDP variables}
# For all variables in following table, add a new variable to data with the name
# "OldName pGDP". Calculate its value by 
#     OldValue / (GDP|PPP pCap) * conversionFactor 
# and set its unit to newUnit. 
# The new variable "OldName pGDP" will be available in the plot sections.
pGdpVariables <- tribble(
  ~variable, ~newUnit, ~conversionFactor,
  "FE", "MJ/US$2005", 1e3,
  "FE|CDR", "MJ/US$2005", 1e3,
  "FE|Transport", "MJ/US$2005", 1e3,
  "FE|Buildings", "MJ/US$2005", 1e3,
  "FE|Industry", "MJ/US$2005", 1e3)
data %>% 
  inner_join(pGdpVariables) %>% 
  mutate(
    value = value / gdp * conversionFactor,
    variable = paste0(variable, " pGDP"),
    unit = newUnit,
    newUnit = NULL, conversionFactor = NULL) ->
  dataPGdp
data %>% 
  bind_rows(dataPGdp) ->
  data
```


```{r corrections}
# TODO: This should definitely not be done here!!

# correct SE|Electricity|Hydrogen, current value is FE, SE can be calculated by
# estimating turbine efficiency
data %>% 
  mutate(
    value = value / ifelse(variable == "SE|Electricity|Hydrogen", 0.4, 1)) ->
  data
```


```{r define additional global variables}
# Define some global variables for use in plotting. 
variables <- unique(data$variable)
regions <- unique(data$region)
mainReg <- params$mainReg
y_bar <- params$y_bar
```


```{r include plot functions, child = "cs2_plot_functions.Rmd"}
```


```{r prepare mark}
# CLICK "RUN ALL RUNS ABOVE" HERE TO PREPARE YOUR ENVIRONMENT
```


```{r section_paths, include=FALSE}
# Set the paths of the section's *.Rmd-files.
if (is.null(params$includes)) {
  includes <- c(
    "summary",
    "macro",
    "emissions",
    "energy_supply",
    "energy_demand",
    "energy_services",
    "climate")
} else {
  includes <- params$includes
}
if (length(includes) > 0) {
  section_paths <- paste0("cs2_", includes, ".Rmd")
} else {
  section_paths <- character(0)
}
```


```{r include sections, child = section_paths}
```
